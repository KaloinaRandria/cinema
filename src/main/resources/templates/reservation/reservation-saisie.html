<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="'Réserver - ' + ${seance.id}">Réserver</title>
    <th:block th:insert="~{fragment/load_css :: load_css}"></th:block>
    <th:block th:insert="~{fragment/font :: font}"></th:block>

    <style>
        .seat-line { display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; }
        .seat-line .btn { white-space: nowrap; }
        .seat-select { min-width: 220px; }
    </style>
</head>
<body>
<div th:replace="~{fragment/sidebar :: sidebar}"></div>

<div class="main-content">
    <section>
        <div th:replace="~{fragment/load_pop_up :: pop_up}"></div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="fw-bold text-gradient-blue">
                <i class="fas fa-ticket-alt me-3 icon-gradient-blue"></i> Réserver
            </h1>
            <a th:href="@{/seance/{id}(id=${seance.id})}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Retour
            </a>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-4">

                <div class="mb-3">
                    <strong>Séance :</strong> <span th:text="${seance.id}"></span><br>
                    <strong>Film :</strong> <span th:text="${seance.film.titre}"></span><br>
                    <strong>Salle :</strong> <span th:text="${salle.nom}"></span><br>
                    <strong>Prix :</strong> <span th:text="${seance.prix}"></span> Ar / siège
                </div>

                <div class="alert alert-info" th:if="${#lists.isEmpty(availableSeats)}">
                    Aucun siège disponible pour cette séance.
                </div>

                <form th:if="${!#lists.isEmpty(availableSeats)}"
                      th:action="@{/reservation/create}" method="post" id="reservationForm">

                    <input type="hidden" name="idSeance" th:value="${seance.id}">

                    <!-- Données (sans API) : on injecte la liste des sièges dispo en JS -->
                    <script th:inline="javascript">
                        /*<![CDATA[*/
                        const AVAILABLE_SEATS = /*[[${availableSeats}]]*/ [];
                        /*]]>*/
                    </script>


                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">
                            <i class="fas fa-chair me-2"></i>Choisir vos sièges
                        </h6>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-gradient-blue" id="btnAddSeat">
                                <i class="fas fa-plus me-1"></i>Ajouter un siège
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnReset">
                                <i class="fas fa-undo me-1"></i>Réinitialiser
                            </button>
                        </div>
                    </div>

                    <div id="seatLines" class="mt-2"></div>

                    <div class="alert alert-warning mt-3 d-none" id="alertDuplicate">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Vous avez sélectionné le même siège plusieurs fois.
                    </div>

                    <div class="alert alert-info mt-3" id="recapBox">
                        <div><strong>Sièges :</strong> <span id="recapSeats">Aucun</span></div>
                        <div><strong>Nombre :</strong> <span id="recapCount">0</span></div>
                        <div><strong>Total :</strong> <span id="recapTotal">0</span> Ar</div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-gradient-green" type="submit" id="btnSubmit" disabled>
                            <i class="fas fa-check-circle me-1"></i> Confirmer
                        </button>
                    </div>
                </form>

                <small class="text-muted d-block mt-3">
                    Les sièges affichés sont ceux disponibles au chargement de la page.
                    Le serveur revérifie la disponibilité au moment de la confirmation.
                </small>

            </div>
        </div>
    </section>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const PRIX = Number(/*[[${seance.prix}]]*/ 0);
    /*]]>*/
</script>


<script>
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', () => {
        const seatLines = document.getElementById('seatLines');
        const btnAddSeat = document.getElementById('btnAddSeat');
        const btnReset = document.getElementById('btnReset');
        const alertDuplicate = document.getElementById('alertDuplicate');
        const btnSubmit = document.getElementById('btnSubmit');

        const recapSeats = document.getElementById('recapSeats');
        const recapCount = document.getElementById('recapCount');
        const recapTotal = document.getElementById('recapTotal');

        // ✅ Convertit en options
        function seatLabel(s) {
            // s.rangee + s.numero (adapte si tes champs sont différents)
            return `${s.rangee}${s.numero}`;
        }

        function buildSelect() {
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm seat-select';
            select.name = 'seatIds[]';
            select.required = true;

            const o0 = document.createElement('option');
            o0.value = '';
            o0.textContent = '-- Choisir un siège --';
            select.appendChild(o0);

            (Array.isArray(AVAILABLE_SEATS) ? AVAILABLE_SEATS : []).forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = seatLabel(s);
                select.appendChild(opt);
            });

            select.addEventListener('change', refresh);
            return select;
        }

        function addLine() {
            const line = document.createElement('div');
            line.className = 'seat-line';

            const select = buildSelect();

            const btnRemove = document.createElement('button');
            btnRemove.type = 'button';
            btnRemove.className = 'btn btn-sm btn-outline-danger';
            btnRemove.innerHTML = '<i class="fas fa-trash me-1"></i>Retirer';
            btnRemove.addEventListener('click', () => {
                line.remove();
                refresh();
            });

            line.appendChild(select);
            line.appendChild(btnRemove);
            seatLines.appendChild(line);

            refresh();
        }

        function refresh() {
            const selects = Array.from(seatLines.querySelectorAll('select'));
            const values = selects.map(s => s.value).filter(v => v);

            // duplicats ?
            const hasDuplicate = (new Set(values)).size !== values.length;
            alertDuplicate.classList.toggle('d-none', !hasDuplicate);

            // recap
            const idToSeat = new Map((AVAILABLE_SEATS || []).map(s => [s.id, s]));
            const labels = values.map(id => idToSeat.get(id)).filter(Boolean).map(seatLabel);

            recapSeats.textContent = labels.length ? labels.join(', ') : 'Aucun';
            recapCount.textContent = String(labels.length);
            recapTotal.textContent = String(labels.length * PRIX);

            // submit ok ?
            btnSubmit.disabled = (labels.length === 0 || hasDuplicate);
        }

        btnAddSeat.addEventListener('click', addLine);

        btnReset.addEventListener('click', () => {
            seatLines.innerHTML = '';
            addLine(); // 1 ligne obligatoire
        });

        // 1 ligne obligatoire au départ
        addLine();
    });
    /*]]>*/
</script>

</body>
</html>
